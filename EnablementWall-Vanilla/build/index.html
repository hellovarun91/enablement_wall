<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Daleel - Enablement Wall</title>
  <link rel="icon" href="./favicon.ico">
  <!-- NO LOTTIE - Using pure CSS buttons for BrightSign compatibility -->
  <style>
    /* DiodrumArabic Font Family */
    @font-face {
      font-family: 'Diodrum Arabic';
      src: url('./fonts/DiodrumArabic-Extralight.otf') format('opentype');
      font-weight: 200;
      font-style: normal;
    }
    @font-face {
      font-family: 'Diodrum Arabic';
      src: url('./fonts/DiodrumArabic-Light.otf') format('opentype');
      font-weight: 300;
      font-style: normal;
    }
    @font-face {
      font-family: 'Diodrum Arabic';
      src: url('./fonts/DiodrumArabic-Regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
    }
    @font-face {
      font-family: 'Diodrum Arabic';
      src: url('./fonts/DiodrumArabic-Medium.otf') format('opentype');
      font-weight: 500;
      font-style: normal;
    }
    @font-face {
      font-family: 'Diodrum Arabic';
      src: url('./fonts/DiodrumArabic-Semibold.otf') format('opentype');
      font-weight: 600;
      font-style: normal;
    }
    @font-face {
      font-family: 'Diodrum Arabic';
      src: url('./fonts/DiodrumArabic-Bold.otf') format('opentype');
      font-weight: 700;
      font-style: normal;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Remove focus/active outlines and tap highlights on all interactive elements */
    button, a, select, input, [onclick] {
      outline: none !important;
      -webkit-tap-highlight-color: transparent !important;
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      user-select: none !important;
    }
    button:focus, button:active, button:-webkit-focus-ring-color,
    a:focus, a:active,
    select:focus, select:active,
    [onclick]:focus, [onclick]:active {
      outline: none !important;
      box-shadow: none !important;
      -webkit-appearance: none !important;
    }
    /* Remove yellow/orange highlight on touch */
    * {
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0) !important;
    }

    body {
      font-family: 'Diodrum Arabic', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
    }

    /* Pages - visibility hidden for non-active pages */
    .page {
      display: none;
      visibility: hidden;
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      background: #000;
    }
    .page.active {
      display: flex;
      visibility: visible;
      z-index: 10;
    }

    /* Loader */
    .loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
    }
    .loader-spinner {
      width: 64px;
      height: 64px;
      border: 4px solid rgba(64, 217, 199, 0.3);
      border-top-color: #40D9C7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Home Page */
    #page-home {
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #000;
      gap: 30px;
    }
    #page-home h1 { color: #40D9C7; font-size: 24px; }
    #page-home select {
      width: 320px;
      padding: 15px;
      font-size: 16px;
      background: #1a1a1a;
      color: white;
      border: 1px solid #444;
      border-radius: 6px;
      cursor: pointer;
    }
    #page-home button {
      padding: 15px 40px;
      font-size: 16px;
      background: transparent;
      color: white;
      border: 1px solid #555;
      border-radius: 6px;
      cursor: pointer;
      display: none;
    }
    #page-home button.visible { display: block; }
    #page-home button:hover { border-color: #40D9C7; color: #40D9C7; }

    /* Video Pages */
    #page-loop, #page-video {
      background: #000;
      position: relative;
    }
    .video-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    .video-bg {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    /* Watch Button - CSS only, no Lottie */
    .watch-btn {
      position: absolute;
      top: 768px;
      left: 86px;
      width: 200px;
      height: 200px;
      border: 4px solid #40D9C7;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      cursor: pointer;
      z-index: 20;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      -webkit-animation: pulse 2s infinite;
      animation: pulse 2s infinite;
    }
    .watch-btn-icon {
      width: 60px;
      height: 60px;
      border: none;
      border-left: 20px solid #40D9C7;
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      background: transparent;
      margin-left: 10px;
    }
    .watch-btn-text {
      color: #40D9C7;
      font-size: 16px;
      font-weight: 600;
      margin-top: 10px;
    }
    @-webkit-keyframes pulse {
      0% { -webkit-transform: scale(1); opacity: 1; }
      50% { -webkit-transform: scale(1.05); opacity: 0.8; }
      100% { -webkit-transform: scale(1); opacity: 1; }
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Watch Video button glow animation */
    @keyframes watchGlow {
      0% { opacity: 0.85; box-shadow: 0 0 10px rgba(64, 217, 199, 0.3); text-shadow: 0 0 5px rgba(64, 217, 199, 0.3); }
      50% { opacity: 1; box-shadow: 0 0 25px rgba(64, 217, 199, 0.6); text-shadow: 0 0 15px rgba(64, 217, 199, 0.8); }
      100% { opacity: 0.85; box-shadow: 0 0 10px rgba(64, 217, 199, 0.3); text-shadow: 0 0 5px rgba(64, 217, 199, 0.3); }
    }
    #watchBtn {
      animation: watchGlow 2s ease-in-out infinite;
    }

    /* Close/Skip Button - CSS only */
    .close-btn {
      position: absolute;
      bottom: 40px;
      left: 50%;
      -webkit-transform: translateX(-50%);
      transform: translateX(-50%);
      width: 120px;
      height: 120px;
      border: 3px solid #40D9C7;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      cursor: pointer;
      z-index: 20;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .close-btn-x {
      font-size: 40px;
      color: #40D9C7;
      font-weight: 300;
      line-height: 1;
    }
    .close-btn-text {
      color: #40D9C7;
      font-size: 12px;
      margin-top: 4px;
    }

    /* Reset Button - more visible */
    .reset-btn {
      position: absolute;
      bottom: 30px;
      left: 86px;
      color: #40D9C7;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid #40D9C7;
      border-radius: 20px;
      font-size: 14px;
      padding: 10px 20px;
      cursor: pointer;
      z-index: 20;
    }

    /* Enablers Page */
    #page-enablers {
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      background: #1e2f2d;
    }
    .enablers-bg {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.3;
      z-index: 0;
    }
    .enablers-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100%;
      padding: 38px 43px 230px;
      max-width: 100%;
      width: 100%;
    }
    .enablers-title {
      font-size: 48px;
      font-weight: 500;
      color: #40D9C7;
      margin-bottom: 19px;
      text-align: left;
      width: 100%;
      flex-shrink: 0;
      padding-left: 22px;
    }
    .enablers-list {
      display: flex;
      flex-direction: column;
      gap: 19px;
      width: 100%;
      max-height: 1574px;
      overflow-y: auto;
      padding: 10px 22px;
    }
    .nav-buttons {
      position: fixed;
      bottom: 58px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      z-index: 100;
    }
    .enabler-btn {
      border: 2px solid white;
      background-color: rgba(0, 0, 0, 0.25);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      color: white;
      padding: 29px 22px;
      border-radius: 9999px;
      width: 100%;
      font-size: 24px;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    .enabler-btn:hover {
      border-color: #40D9C7;
      color: #40D9C7;
    }

    /* Nav Buttons - handled above with fixed positioning */
    .nav-btn {
      width: 64px;
      height: 64px;
      border: 1px solid #40D9C7;
      background: rgba(0, 0, 0, 0.25);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .nav-btn:hover { background: rgba(64, 217, 199, 0.1); }
    .nav-btn svg {
      width: 24px;
      height: 24px;
      stroke: #40D9C7;
      fill: none;
    }

    /* Details Page */
    #page-details {
      flex-direction: column;
      align-items: center;
      position: relative;
      background: #1e2f2d;
    }
    .details-bg {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.3;
      z-index: 0;
    }
    .details-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      height: 100%;
      padding: 38px 43px 0;
      max-width: 100%;
      width: 100%;
    }
    .details-title {
      font-size: 48px;
      font-weight: 700;
      color: #40D9C7;
      margin-bottom: 6px;
      flex-shrink: 0;
      padding-left: 22px;
    }
    .details-subtitle {
      display: none;
    }
    .details-cards {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 20px;
      width: 100%;
      flex: 1;
      overflow-y: auto;
      padding: 10px 22px 256px;
    }
    .bottom-gradient {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 256px;
      background: linear-gradient(to bottom, transparent 0%, rgba(13,41,38,0.8) 50%, rgba(13,41,38,1) 100%);
      pointer-events: none;
      z-index: 50;
    }
    .detail-card {
      border: 2px solid #40D9C7;
      border-radius: 18px;
      padding: 38px 22px;
      background: rgba(0,0,0,0.3);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
    }
    .detail-card-header {
      display: flex;
      align-items: center;
      gap: 11px;
      margin-bottom: 29px;
    }
    .detail-card-icon { width: 77px; height: 77px; }
    .detail-card-title {
      font-size: 24px;
      font-weight: 500;
      color: #40D9C7;
      flex: 1;
    }
    .detail-card-text { color: white; line-height: 1.5; font-size: 18px; }
    .detail-card-list { color: white; margin-left: 20px; line-height: 1.8; }
    .detail-card-link {
      display: inline-block;
      margin-top: 16px;
      padding: 10px 20px;
      background: #40D9C7;
      color: #000;
      font-weight: 700;
      border-radius: 8px;
      text-decoration: none;
    }

    /* Special Page - 2x2 Layout using Flexbox (more compatible than Grid) */
    #page-special {
      display: flex;
      flex-wrap: wrap;
      background: #000;
    }
    .special-item {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      cursor: pointer;
      overflow: hidden;
      width: 50%;
      height: 960px;
    }
    .special-item-bg {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-size: cover;
      background-position: center;
      z-index: 0;
    }
    .special-item-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1;
    }
    .special-item-content {
      position: relative;
      z-index: 2;
      padding: 20px;
    }
    .special-item-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 12px;
      display: block;
    }
    .special-item-btn {
      width: 48px;
      height: 48px;
      border: 2px solid #40D9C7;
      background: transparent;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .special-item-btn span {
      color: #40D9C7;
      font-size: 24px;
      font-weight: 800;
      transform: rotate(-45deg);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(64, 217, 199, 0.5); border-radius: 3px; }

    /* Link Modal - iframe with close button */
    #linkModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 9999;
    }
    #linkModal.active {
      display: flex;
      flex-direction: column;
    }
    #linkIframe {
      flex: 1;
      width: 100%;
      border: none;
      background: #fff;
    }
    #linkModalClose {
      width: 100%;
      height: 60px;
      background: #40D9C7;
      color: #000;
      border: none;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

  <!-- Black Overlay - Covers hardware video layer during transitions to prevent blue flash -->
  <div id="blackOverlay" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000; z-index:9000; display:none;"></div>

  <!-- Link Modal - Website opens in iframe, close button at bottom -->
  <div id="linkModal">
    <iframe id="linkIframe" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
    <button id="linkModalClose">✕ Return to App</button>
  </div>

  <!-- Page: Home -->
  <div id="page-home" class="page active">
    <h1>Enablement Wall</h1>
    <select id="screenSelect">
      <option value="">-- Select Screen --</option>
    </select>
    <button id="goBtn">Go</button>
  </div>

  <!-- Page: Loop - Video with hwz="z-index:-1" to render BEHIND HTML elements (BrightSign feature) -->
  <div id="page-loop" class="page">
    <!-- Loop video: preload=auto ensures full buffer before play, hidden until ready to prevent glitches -->
    <video id="loopVideo" hwz="z-index:-1" loop muted playsinline preload="auto" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:1; background:#000; opacity:0;"></video>
    <!-- Fallback poster image if video fails -->
    <div id="loopPoster" style="position:absolute; top:0; left:0; width:100%; height:100%; background-size:cover; background-position:center; background-color:#000; z-index:2; display:none;"></div>
    <!-- Loader -->
    <div id="loopLoader" style="position:absolute; top:40%; left:50%; z-index:50;"><div class="loader-spinner"></div></div>
    <!-- Watch Video Button - will appear OVER video thanks to hwz="z-index:-1" -->
    <button id="watchBtn" style="position:absolute; bottom:48%; left:11%; padding:20px 50px; border:1px solid #40D9C7; border-radius:50px; background-color:rgba(0,0,0,0.15); cursor:pointer; color:#40D9C7; font-size:24px; font-weight:bold; text-align:center; z-index:100;">Watch Video</button>
    <!-- Reset Screen Button - hidden in top-right corner, larger touch area -->
    <button id="resetBtn" style="position:absolute; top:0; right:0; width:100px; height:100px; padding:0; border:none; background-color:transparent; color:transparent; font-size:1px; cursor:default; z-index:100; opacity:0;"></button>
  </div>

  <!-- Page: Main Video -->
  <div id="page-video" class="page">
    <!-- Main video: hidden until ready to prevent glitches -->
    <video id="mainVideo" hwz="z-index:-1" muted playsinline preload="auto" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; background:#000; opacity:0;"></video>
    <!-- Skip button - overlay on video, bottom right corner - made more visible -->
    <button id="closeBtn" style="position:absolute; bottom:5%; right:5%; padding:20px 50px; border:2px solid #40D9C7; border-radius:50px; background-color:rgba(0,0,0,0.7); cursor:pointer; color:#40D9C7; font-size:24px; font-weight:bold; z-index:100;">Skip →</button>
    <!-- Loader -->
    <div id="videoLoader" style="position:absolute; top:48%; left:50%; z-index:50;"><div class="loader-spinner"></div></div>
  </div>

  <!-- Page: Enablers List -->
  <div id="page-enablers" class="page">
    <div class="enablers-bg" id="enablersBg"></div>
    <div class="enablers-content">
      <h1 class="enablers-title" id="enablersTitle"></h1>
      <div class="enablers-list" id="enablersList"></div>
    </div>
    <div class="nav-buttons">
      <button class="nav-btn back-btn" id="backBtn" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
      </button>
      <button class="nav-btn" id="homeBtn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </button>
    </div>
  </div>

  <!-- Page: Enabler Details -->
  <div id="page-details" class="page">
    <div class="details-bg"></div>
    <div class="details-content">
      <h1 class="details-title" id="detailsTitle"></h1>
      <p class="details-subtitle" id="detailsSubtitle"></p>
      <div class="details-cards" id="detailsCards"></div>
    </div>
    <div class="bottom-gradient"></div>
    <div class="nav-buttons">
      <button class="nav-btn back-btn" id="detailsBackBtn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
      </button>
      <button class="nav-btn" id="detailsHomeBtn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </button>
    </div>
  </div>

  <!-- Page: Special Enablers -->
  <div id="page-special" class="page"></div>

  <script>
    // ===== GLOBAL DATA =====
    var configData = [];
    var enablersData = [];
    var selectedScreen = null;

    // Navigation protection flags - prevent accidental triggers
    var isNavigating = false;
    var currentPage = null;

    // ===== LINK MODAL FUNCTIONS =====
    var linkModalOpen = false;

    function openLinkModal(url) {
      var modal = document.getElementById('linkModal');
      var iframe = document.getElementById('linkIframe');

      // Push a history state so back button closes modal instead of navigating
      history.pushState({ modal: true }, '');

      iframe.src = url;
      modal.classList.add('active');
      linkModalOpen = true;
    }

    function closeLinkModal() {
      var modal = document.getElementById('linkModal');
      var iframe = document.getElementById('linkIframe');
      // First clear iframe to prevent history issues
      iframe.src = 'about:blank';
      modal.classList.remove('active');
      linkModalOpen = false;
    }

    // Setup close button and back button handling
    document.addEventListener('DOMContentLoaded', function() {
      var closeBtn = document.getElementById('linkModalClose');
      if (closeBtn) {
        closeBtn.onclick = function() {
          closeLinkModal();
          // Go back in history to remove the modal state we pushed
          history.back();
        };
      }

      // Handle back button when modal is open
      window.addEventListener('popstate', function(e) {
        if (linkModalOpen) {
          closeLinkModal();
          // No need for preventDefault - the modal history state is already popped
        }
      });
    });

    // ===== IDLE TIMEOUT =====
    // Return to loop page after 2 minutes of inactivity
    var IDLE_TIMEOUT = 120000; // 2 minutes in milliseconds
    var idleTimer = null;

    function resetIdleTimer() {
      // Clear existing timer
      if (idleTimer) {
        clearTimeout(idleTimer);
      }
      // Only set new timer if not on home or loop page
      if (currentPage !== 'home' && currentPage !== 'loop') {
        idleTimer = setTimeout(function() {
          // Return to loop page (keeps selected screen)
          navigate('loop');
        }, IDLE_TIMEOUT);
      }
    }

    // Reset timer on any user interaction
    document.addEventListener('touchstart', resetIdleTimer, { passive: true });
    document.addEventListener('click', resetIdleTimer);
    document.addEventListener('touchmove', resetIdleTimer, { passive: true });

    // Start idle timer on page load
    document.addEventListener('DOMContentLoaded', function() {
      resetIdleTimer();
    });

    // ===== BLACK OVERLAY - Hides hardware video layer during transitions =====
    function showBlackOverlay() {
      var overlay = document.getElementById('blackOverlay');
      if (overlay) overlay.style.display = 'block';
    }

    function hideBlackOverlay() {
      var overlay = document.getElementById('blackOverlay');
      if (overlay) overlay.style.display = 'none';
    }

    // ===== HELPERS =====
    function cleanupPage(oldPage) {
      // Cleanup: pause video, hide it, clear source to release memory
      if (oldPage === 'loop') {
        var loopVideo = document.getElementById('loopVideo');
        var loopPoster = document.getElementById('loopPoster');
        if (loopVideo) {
          loopVideo.pause();
          loopVideo.style.opacity = '0'; // Hide to prevent flash on return
          loopVideo.oncanplaythrough = null;
          loopVideo.onplaying = null;
          loopVideo.onended = null;
          loopVideo.onerror = null;
          loopVideo.src = '';
          loopVideo.removeAttribute('src');
          loopVideo.load(); // Release memory
        }
        if (loopPoster) {
          loopPoster.style.display = 'none';
        }
      }
      if (oldPage === 'video') {
        var mainVideo = document.getElementById('mainVideo');
        if (mainVideo) {
          mainVideo.pause();
          mainVideo.style.opacity = '0'; // Hide to prevent flash
          mainVideo.oncanplaythrough = null;
          mainVideo.onplaying = null;
          mainVideo.onended = null;
          mainVideo.onerror = null;
          mainVideo.src = '';
          mainVideo.removeAttribute('src');
          mainVideo.load(); // Release memory
        }
      }
    }

    function showPage(pageId) {
      // Cleanup old page first
      if (currentPage && currentPage !== pageId) {
        cleanupPage(currentPage);
      }
      currentPage = pageId;

      var pages = document.querySelectorAll('.page');
      for (var i = 0; i < pages.length; i++) {
        pages[i].classList.remove('active');
      }
      var page = document.getElementById('page-' + pageId);
      if (page) page.classList.add('active');
    }

    function getHashParams() {
      var hash = window.location.hash.slice(1);
      var parts = hash.split('?');
      var route = parts[0] || 'home';
      var params = {};
      if (parts[1]) {
        var pairs = parts[1].split('&');
        for (var i = 0; i < pairs.length; i++) {
          var kv = pairs[i].split('=');
          params[kv[0]] = decodeURIComponent(kv[1]);
        }
      }
      return { route: route, params: params };
    }

    function navigate(hash) {
      // Prevent double navigation
      if (isNavigating) return;
      isNavigating = true;
      window.location.hash = hash;
      // Reset idle timer on navigation
      resetIdleTimer();
      // Reset flag after short delay
      setTimeout(function() { isNavigating = false; }, 100);
    }

    // ===== LOAD DATA =====
    function loadData() {
      fetch('./config.json')
        .then(function(res) { return res.json(); })
        .then(function(data) {
          configData = data;
          return fetch('./data.json');
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          enablersData = data;
          initApp();
        })
        .catch(function(err) {
          console.error('Failed to load data:', err);
          alert('Failed to load data: ' + err.message);
        });
    }

    // ===== INIT APP =====
    function initApp() {
      initHomePage();
      handleRoute();
    }

    // ===== HOME PAGE =====
    function initHomePage() {
      var select = document.getElementById('screenSelect');
      var goBtn = document.getElementById('goBtn');

      // Populate dropdown
      select.innerHTML = '<option value="">-- Select Screen --</option>';
      for (var i = 0; i < configData.length; i++) {
        var option = document.createElement('option');
        option.value = i;
        option.textContent = configData[i].name;
        select.appendChild(option);
      }

      // Selection handler
      select.onchange = function() {
        var index = this.value;
        if (index !== '') {
          selectedScreen = configData[index];
          localStorage.setItem('data', JSON.stringify(selectedScreen));
          goBtn.classList.add('visible');
        }
      };

      // Go button
      goBtn.onclick = function() {
        if (selectedScreen) {
          navigate('loop');
        }
      };
    }

    // ===== LOOP PAGE (ANTI-GLITCH) =====
    // BrightSign fix: Hide video until fully buffered to prevent frame tearing
    function initLoopPage() {
      var data = JSON.parse(localStorage.getItem('data'));
      if (!data) { navigate('home'); return; }

      var loopVideo = document.getElementById('loopVideo');
      var loopPoster = document.getElementById('loopPoster');
      var loader = document.getElementById('loopLoader');
      var watchBtnEl = document.getElementById('watchBtn');
      var resetBtn = document.getElementById('resetBtn');
      var isVideoReady = false;

      // Show loader and poster, hide video until ready
      loader.style.display = 'block';
      loopVideo.style.opacity = '0';

      // Show poster image as background while video loads
      if (data.posterImage) {
        loopPoster.style.backgroundImage = 'url(.' + data.posterImage + ')';
        loopPoster.style.display = 'block';
      }

      // Clear any previous handlers
      loopVideo.oncanplaythrough = null;
      loopVideo.onplaying = null;
      loopVideo.onended = null;
      loopVideo.onerror = null;

      // Set video source
      loopVideo.src = '.' + data.loopVideoUrl;
      loopVideo.load();

      // Wait for video to be fully buffered before showing
      loopVideo.oncanplaythrough = function() {
        if (isVideoReady) return;
        isVideoReady = true;

        // Hide poster, show video, hide loader
        loopPoster.style.display = 'none';
        loopVideo.style.opacity = '1';
        loader.style.display = 'none';

        // Hide black overlay - video is ready on hardware layer
        hideBlackOverlay();

        // Now play (after video is visible and ready)
        loopVideo.play();
      };

      // Fallback: Manual loop in case loop attribute fails
      loopVideo.onended = function() {
        if (currentPage !== 'loop') return;
        loopVideo.currentTime = 0;
        loopVideo.play();
      };

      // Error handling: Show poster if video fails
      loopVideo.onerror = function() {
        loader.style.display = 'none';
        if (data.posterImage) {
          loopPoster.style.display = 'block';
        }
      };

      // Watch Video button - show black overlay FIRST to hide hardware layer
      watchBtnEl.onclick = function() {
        showBlackOverlay();
        navigate('video');
      };

      // Reset button
      resetBtn.onclick = function() {
        navigate('home');
      };
    }

    // ===== VIDEO PAGE (ANTI-GLITCH) =====
    // BrightSign fix: Hide video until fully buffered to prevent frame tearing
    function initVideoPage() {
      var data = JSON.parse(localStorage.getItem('data'));
      if (!data) { navigate('home'); return; }

      var video = document.getElementById('mainVideo');
      var loader = document.getElementById('videoLoader');
      var closeBtnEl = document.getElementById('closeBtn');
      var hasNavigated = false;
      var isVideoReady = false;

      // Show loader, hide video until ready
      loader.style.display = 'block';
      video.style.opacity = '0';

      // Clear any previous handlers
      video.oncanplaythrough = null;
      video.onplaying = null;
      video.onended = null;
      video.onerror = null;

      // Set video source
      video.src = '.' + data.mainVideoUrl;
      video.load();

      // Go to next page
      var goToNext = function() {
        if (hasNavigated) return;
        hasNavigated = true;
        video.pause();
        video.style.opacity = '0'; // Hide before navigating to prevent flash
        if (data.index === 5) {
          navigate('special');
        } else {
          navigate('enablers?id=1&card=' + data.id);
        }
      };

      // Wait for video to be fully buffered before showing
      video.oncanplaythrough = function() {
        if (isVideoReady) return;
        isVideoReady = true;

        // Show video and hide loader
        video.style.opacity = '1';
        loader.style.display = 'none';

        // Hide black overlay - video is ready on hardware layer
        hideBlackOverlay();

        // Now play (after video is visible and ready)
        video.play();
      };

      // When video ends, go to next page
      video.onended = function() {
        if (currentPage !== 'video') return;
        goToNext();
      };

      // Error handling
      video.onerror = function() {
        loader.style.display = 'none';
        hideBlackOverlay(); // Hide overlay even on error
        goToNext(); // Move to next page on error
      };

      // Skip button
      closeBtnEl.onclick = goToNext;
    }

    // ===== ENABLERS PAGE =====
    function initEnablersPage(params) {
      var id = params.id;
      var card = params.card;

      var category = null;
      for (var i = 0; i < enablersData.length; i++) {
        if (enablersData[i].id === id) { category = enablersData[i]; break; }
      }
      if (!category) return;

      var enabler = null;
      for (var j = 0; j < category.enablers.length; j++) {
        if (category.enablers[j].id == card) { enabler = category.enablers[j]; break; }
      }
      if (!enabler) return;

      document.getElementById('enablersTitle').textContent = enabler.enablerName;

      // Set background image
      var screenData = JSON.parse(localStorage.getItem('data'));
      var bgImageUrl;
      if (screenData && screenData.posterImage && screenData.index !== 5) {
        bgImageUrl = screenData.posterImage;
      } else if (enabler.bgImage) {
        bgImageUrl = enabler.bgImage;
      } else {
        bgImageUrl = '/posters/poster-01.jpg';
      }
      document.getElementById('enablersBg').style.backgroundImage = 'url(.' + bgImageUrl + ')';

      var list = document.getElementById('enablersList');
      list.innerHTML = '';
      for (var k = 0; k < enabler.enablerItem.length; k++) {
        var item = enabler.enablerItem[k];
        var btn = document.createElement('button');
        btn.className = 'enabler-btn';
        btn.textContent = item.name;
        btn.dataset.id = item.id;
        btn.onclick = function() {
          navigate('details?id=' + id + '&card=' + card + '&ei_id=' + this.dataset.id);
        };
        list.appendChild(btn);
      }

      // Reset scroll position
      list.scrollTop = 0;

      // Show back button only for special enablers (id=2)
      document.getElementById('backBtn').style.display = id === '2' ? 'flex' : 'none';
      document.getElementById('backBtn').onclick = function() { window.history.back(); };
      document.getElementById('homeBtn').onclick = function() { navigate('loop'); };
    }

    // ===== DETAILS PAGE =====
    function initDetailsPage(params) {
      var id = params.id;
      var card = params.card;
      var ei_id = params.ei_id;

      var category = null;
      for (var i = 0; i < enablersData.length; i++) {
        if (enablersData[i].id === id) { category = enablersData[i]; break; }
      }
      if (!category) return;

      var enabler = null;
      for (var j = 0; j < category.enablers.length; j++) {
        if (category.enablers[j].id == card) { enabler = category.enablers[j]; break; }
      }
      if (!enabler || !enabler.enablerItem) return;

      var detail = null;
      for (var k = 0; k < enabler.enablerItem.length; k++) {
        if (enabler.enablerItem[k].id == ei_id) { detail = enabler.enablerItem[k]; break; }
      }
      if (!detail) return;

      document.getElementById('detailsTitle').textContent = detail.name;
      document.getElementById('detailsSubtitle').textContent = detail.nameIn || '';

      // Set background image
      var screenData = JSON.parse(localStorage.getItem('data'));
      var bgImageUrl;
      if (screenData && screenData.posterImage && screenData.index !== 5) {
        bgImageUrl = screenData.posterImage;
      } else if (enabler.bgImage) {
        bgImageUrl = enabler.bgImage;
      } else {
        bgImageUrl = '/posters/poster-01.jpg';
      }
      document.querySelector('.details-bg').style.backgroundImage = 'url(.' + bgImageUrl + ')';

      var cardsEl = document.getElementById('detailsCards');
      cardsEl.innerHTML = '';

      for (var m = 0; m < detail.content.length; m++) {
        var item = detail.content[m];
        var cardDiv = document.createElement('div');
        cardDiv.className = 'detail-card';

        if (item.textDone && item.textDone.trim() !== '') {
          var textP = document.createElement('p');
          textP.className = 'detail-card-text';
          textP.textContent = item.textDone;
          cardDiv.appendChild(textP);

          if (item.link && item.link[0] && item.link[0].value) {
            var linkBtn = document.createElement('button');
            var linkUrl = item.link[0].value;
            linkBtn.textContent = item.link[0].name || 'Visit';
            linkBtn.style.display = 'inline-block';
            linkBtn.style.marginTop = '16px';
            linkBtn.style.padding = '10px 20px';
            linkBtn.style.backgroundColor = '#40D9C7';
            linkBtn.style.color = '#000000';
            linkBtn.style.fontWeight = '700';
            linkBtn.style.borderRadius = '8px';
            linkBtn.style.border = 'none';
            linkBtn.style.cursor = 'pointer';
            linkBtn.style.fontSize = '14px';
            linkBtn.onclick = function() {
              openLinkModal(linkUrl);
            };
            cardDiv.appendChild(linkBtn);
          }
        } else {
          var header = document.createElement('div');
          header.className = 'detail-card-header';

          if (item.icon) {
            var icon = document.createElement('img');
            icon.className = 'detail-card-icon';
            icon.src = '.' + item.icon;
            icon.onerror = function() { this.style.display = 'none'; };
            header.appendChild(icon);
          }

          var title = document.createElement('h3');
          title.className = 'detail-card-title';
          title.textContent = item.name || '';
          header.appendChild(title);

          cardDiv.appendChild(header);

          if (item.text) {
            var textP2 = document.createElement('p');
            textP2.className = 'detail-card-text';
            textP2.textContent = item.text;
            cardDiv.appendChild(textP2);
          }

          if (item.list && item.list.length > 0) {
            var ul = document.createElement('ul');
            ul.className = 'detail-card-list';
            for (var n = 0; n < item.list.length; n++) {
              var li = document.createElement('li');
              li.textContent = item.list[n];
              ul.appendChild(li);
            }
            cardDiv.appendChild(ul);
          }
        }

        cardsEl.appendChild(cardDiv);
      }

      // Reset scroll position
      cardsEl.scrollTop = 0;

      document.getElementById('detailsBackBtn').onclick = function() { window.history.back(); };
      document.getElementById('detailsHomeBtn').onclick = function() { navigate('loop'); };
    }

    // ===== SPECIAL PAGE =====
    function initSpecialPage() {
      var specialData = enablersData[1]; // Index 1 is Special Enablers
      if (!specialData || !specialData.enablers) return;

      var container = document.getElementById('page-special');
      container.innerHTML = '';

      for (var i = 0; i < specialData.enablers.length; i++) {
        var item = specialData.enablers[i];

        var div = document.createElement('div');
        div.className = 'special-item';
        div.dataset.id = item.id;

        var bg = document.createElement('div');
        bg.className = 'special-item-bg';
        bg.style.backgroundImage = 'url(.' + item.bgImage + ')';
        div.appendChild(bg);

        var overlay = document.createElement('div');
        overlay.className = 'special-item-overlay';
        div.appendChild(overlay);

        var content = document.createElement('div');
        content.className = 'special-item-content';

        var title = document.createElement('span');
        title.className = 'special-item-title';
        title.textContent = item.enablerName;
        content.appendChild(title);

        var btn = document.createElement('div');
        btn.className = 'special-item-btn';
        btn.innerHTML = '<span>→</span>';
        content.appendChild(btn);

        div.appendChild(content);

        div.onclick = function() {
          navigate('enablers?id=2&card=' + this.dataset.id);
        };

        container.appendChild(div);
      }
    }

    // ===== ROUTER =====
    function handleRoute() {
      var parsed = getHashParams();
      var route = parsed.route;
      var params = parsed.params;

      switch (route) {
        case 'home':
          showPage('home');
          break;
        case 'loop':
          showPage('loop');
          initLoopPage();
          break;
        case 'video':
          showPage('video');
          initVideoPage();
          break;
        case 'enablers':
          showPage('enablers');
          initEnablersPage(params);
          break;
        case 'details':
          showPage('details');
          initDetailsPage(params);
          break;
        case 'special':
          showPage('special');
          initSpecialPage();
          break;
        default:
          showPage('home');
      }
    }

    // ===== START =====
    window.onhashchange = handleRoute;
    loadData();
  </script>
</body>
</html>
